# VSCode Extension for Flux (with Kind)

## Walkthrough of Demo Part 1

* Let's show how to set up K8s and talk about what `$PS1` you have in your terminal
* Walkthrough installing the extension - finding prerelease builds in GitHub
* Walkthrough installing Flux onto the temporary cluster
* How does this differ from using Flux Bootstrap

tl;dr: To skip the preamble, [Install GitOps Extension](#install-gitops-extension)

Super-tldr; Find the `flux-system` directory that has been bootstrapped already, and
inspect it. Then, when you have determined if it is customized enough for you, run:

```shell
kustomize build flux-system --reorder=none | kubectl apply -f -
```

If you get an error related to GitRepository and Kustomization at the end, you may
simply need to run this command a second time.

(Please fork it, customize the URLs to match yours in `gotk-sync.yaml` and in the
flux-system `kustomization.yaml` files, inspect, upgrade, clave apart, hack, etc.)

#### (Snip)

[See lima-k8s/README.md for the advanced version to work with "intermission" example](/clusters/lima-k8s/README.md)

### Install Flux (Enable GitOps)

The first step is to verify that Flux can run on your cluster.

```
(⎈ |adm@k8s:default):~/gha-demo (main|u=)$ flux check --pre
► checking prerequisites
✗ flux 0.29.3 <0.29.4 (new version is available, please upgrade)
✔ Kubernetes 1.23.6 >=1.20.6-0
✔ prerequisites checks passed
```

If you don't have Flux installed yet, don't worry! The editor extension can help.

#### Fork and Bootstrap Flux

```
GITHUB_USER=yebyen
GITHUB_SOURCE_UPSTREAM=https://github.com/kingdonb/github-actions-demo
GITHUB_SOURCE_FORKED=https://github.com/yebyen/gha-demo
```

I have shortened the repository name for my fork, to conserve screen real-estate.

You can bootstrap from an https URL, but Flux will always ask your permission to
create a Read/Write deploy token unless you have set `GITHUB_TOKEN` and exported it.

It could be understated, the risks which are possible and the priority that Flux
assigns to keeping Flux users safe through behavior built around safe defaults.

Flux wants to constrain its permissions to either read-only or read-write for a
single repository, by default it will do this using a deploy key. It's read-only
for us today. We can change the URL to a public git repository if we're prepared
for the implications of that. (No secrets should be stored unencrypted, and our
encryption keys need to be protected somehow! Either KMS or another solution.)

Let's bootstrap Flux now:

```
flux bootstrap github       \
  --context=k8s             \
  --owner=${GITHUB_USER}    \
  --repository=gha-demo     \
  --branch=main             \
  --personal                \
  --path=clusters/lima-k8s
```

Enter the GitHub PAT and move on to the next step, or for more visibility into what
Flux bootstrap is doing, you can consult the docs for more information on how to
[craft a git secret with the Flux CLI](https://fluxcd.io/docs/cmd/flux_create_secret_git/),
or about [how to handle the first "bootstrap" of Flux manually](https://fluxcd.io/docs/use-cases/azure/#flux-installation-for-azure-devops)
for environments where `flux bootstrap` is not available for one reason or another.

If you are working on a repository that you have already bootstrapped, you can
repeat this step even if your cluster is old or new, you can bootstrap again with
the same options and this is idempotent. However you should be aware that Flux may
overwrite `gotk-components.yaml` and `gotk-sync.yaml` when you do this, so we mark
them up with warnings at the top of the file that say:

```
# This manifest was generated by flux. DO NOT EDIT.
```

You can make any changes in `kustomization.yaml`

Here's how to override the bootstrap URL with another one by patching

(We do this to avoid the need to use a deploy key of any kind with a public repo.)

This way you can install Flux from Git without involving your Git provider in the
authentication of the cluster.

When your Flux manifests are how you want them to look, go ahead and run:

```
kustomize build flux-system --reorder=none | kubectl apply -f -
```

This way you can avoid running `flux bootstrap` again, but still get the main
ideals of a bootstrap installation (where Flux manages itself and Git is the
single source of truth for Flux and everything underneath it!)

To be clear, this is the **last time** you will ever have to run `kubectl apply`
on this cluster! Now, Flux is managing itself via GitOps.

### Install GitOps Extension

(Ed: walk through installing the GitOps extension)

* [Packaging and Installation](https://github.com/weaveworks/vscode-gitops-tools#packaging-and-installation)
* [Releases and Pre-releases](https://github.com/weaveworks/vscode-gitops-tools/releases)

#### What's Next

So you have a minimally bootstrapped Flux installation on your cluster.

* Can I still get the experience of Flux Bootstrap - Yes, absolutely
* How to follow a tutorial guide - also covers "which guides do I need"
  * List of important guides in order to have the full Flux experience
  * The Flux Editor Extension is not a one-man band - UI of Flux is Notifications

##### What else can we do?

Since we have a bare Flux installation now that does not do anything besides managing
itself, we can move on ahead now to setting up our important infrastructure and apps.

* Learn about [Repository Structure](https://fluxcd.io/docs/guides/repository-structure/)
* Install (GitHub) Commit Status Notifications
* Install (Slack) Alert Notification Provider
* Enable monitoring with Prometheus
* Enable Alert-manager, monitor Flux reconcilers

* Configure some additional Kustomizations and/or GitRepos
* Configure Prometheus alerts to notify Slack
* Configure Webhook Receivers
* Configure SOPS and create a root key for the cluster
* Configure some persistent disks to survive the cluster

Using the VScode extension for Flux is not an end-around learning how to operate
it and how the features can be configured.

We can go down any of these roads if we have time and interest!

##### Reminder:

* Roadmap to VSCode Extension's possible future development
  * Limitations of the VSCode extension's model in program capabilities
  * List of top upcoming features in Flux (and where the Editor Extension is going next)
* Let's show some examples on Flux with the VSCode Editor Extension

The examples are in the repository root. Copy from `clusters/rancher` to make them go!
Or try to replicate these results by tab completing with the generators

Eg.

```
$ flux create source git --url https://github.com/kingdonb/podinfo podinfo
$ flux create kustomization --path ./deploy/helm-git --source GitRepository/podinfo podinfo
```

There are some contrived examples already placed in the `podinfo` directory.

Have fun! Reach out to [CNCF/#flux](https://cloud-native.slack.com/channels/flux) on Slack,
or [join the Cloud-Native Slack](https://slack.cncf.io) if you're new to this community!
